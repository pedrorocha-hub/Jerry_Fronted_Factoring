# üìã Instrucciones para Configurar el Audit Log de RIB Reporte Tributario

## Problema Identificado

El historial de auditor√≠a muestra que los campos fueron modificados pero no muestra los valores anteriores ni los nuevos (aparecen como "N/A"). Esto ocurre porque:

1. **No existe la tabla** `rib_reporte_tributario_audit_log` en Supabase
2. **No existen los triggers** que capturen autom√°ticamente los cambios
3. El m√©todo de guardado hace DELETE + INSERT en lugar de UPDATE

## Soluci√≥n

Debes ejecutar el script SQL `rib_reporte_tributario_audit_log_setup.sql` en Supabase para crear la infraestructura necesaria.

## üìù Pasos para Configurar

### 1. Acceder a Supabase

1. Ve a [https://supabase.com](https://supabase.com)
2. Inicia sesi√≥n en tu cuenta
3. Selecciona tu proyecto

### 2. Abrir el SQL Editor

1. En el men√∫ lateral izquierdo, haz clic en **"SQL Editor"** o **"SQL"**
2. Haz clic en **"New query"** o **"Nueva consulta"**

### 3. Ejecutar el Script

1. Abre el archivo `rib_reporte_tributario_audit_log_setup.sql`
2. **Copia TODO el contenido** del archivo
3. P√©galo en el editor SQL de Supabase
4. Haz clic en el bot√≥n **"Run"** o **"Ejecutar"** (generalmente con el icono ‚ñ∂Ô∏è)

### 4. Verificar la Instalaci√≥n

Ejecuta estas consultas en el SQL Editor para verificar que todo se cre√≥ correctamente:

```sql
-- Verificar que la tabla existe
SELECT * FROM information_schema.tables 
WHERE table_name = 'rib_reporte_tributario_audit_log';

-- Verificar que los triggers fueron creados
SELECT trigger_name, event_manipulation, event_object_table 
FROM information_schema.triggers 
WHERE trigger_name LIKE 'rib_reporte_tributario_audit%';

-- Verificar las pol√≠ticas de seguridad
SELECT * FROM pg_policies 
WHERE tablename = 'rib_reporte_tributario_audit_log';
```

Si todas las consultas devuelven resultados, ¬°la configuraci√≥n fue exitosa! ‚úÖ

## üß™ Probar el Audit Log

Despu√©s de ejecutar el script:

1. Ve a la aplicaci√≥n
2. Abre un **RIB Reporte Tributario** existente para editar
3. Modifica alg√∫n campo (por ejemplo, un valor de "Total Activos")
4. Guarda los cambios
5. Haz clic en **"Ver Historial de Cambios"**
6. Ahora deber√≠as ver los valores **anteriores** y **nuevos** correctamente

## üìä Qu√© Hace el Script

El script realiza las siguientes acciones:

### 1. Crea la Tabla de Audit Log
- Tabla: `rib_reporte_tributario_audit_log`
- Columnas:
  - `id`: Identificador √∫nico del log
  - `rib_reporte_tributario_id`: Referencia al reporte
  - `user_id`: Usuario que hizo el cambio
  - `user_email`: Email del usuario
  - `action`: Tipo de acci√≥n (created, updated, status_changed, deleted)
  - `changed_fields`: **SOLO** los campos de negocio que cambiaron
  - `old_values`: Valores anteriores **SOLO** de campos que cambiaron
  - `new_values`: Valores nuevos **SOLO** de campos que cambiaron
  - `created_at`: Fecha y hora del cambio

**Campos Monitoreados (SOLO estos se registran):**
- RUC, A√±o, Tipo de Entidad
- Estado, Solicitud Asociada
- Cuentas por Cobrar del Giro
- Total Activos
- Cuentas por Pagar del Giro
- Total Pasivos
- Capital Pagado
- Total Patrimonio
- Total Pasivo y Patrimonio
- Ingreso por Ventas
- Utilidad Bruta
- Utilidad Antes de Impuesto
- Solvencia
- Gesti√≥n

**Campos IGNORADOS (no se registran):**
- `created_at`, `updated_at`, `user_id` (campos de sistema)

### 2. Crea √çndices
- Optimiza las consultas por `rib_reporte_tributario_id`
- Optimiza las consultas por fecha
- Optimiza las consultas por usuario

### 3. Configura Row Level Security (RLS)
- Los usuarios autenticados pueden **ver** los logs
- El sistema puede **insertar** logs autom√°ticamente

### 4. Crea la Funci√≥n Trigger Inteligente
- Detecta INSERT, UPDATE y DELETE en la tabla `rib_reporte_tributario`
- **IGNORA** campos de sistema (`created_at`, `updated_at`, etc.)
- **SOLO** captura cambios en campos de negocio relevantes (17 campos monitoreados)
- Captura el valor anterior y nuevo **√∫nicamente** del campo que cambi√≥
- Identifica autom√°ticamente si el cambio fue de status o actualizaci√≥n general

### 5. Asocia los Triggers
- Trigger para INSERT (cuando se crean registros)
- Trigger para UPDATE (cuando se modifican registros)
- Trigger para DELETE (cuando se eliminan registros)

## üîç Comportamiento Actual vs. Nuevo

### ANTES (sin triggers o con triggers que capturan TODO):
```
‚ùå Muchos campos irrelevantes:
- created_at: 2025-10-15 ‚Üí 2025-10-16
- updated_at: 2025-10-15 ‚Üí 2025-10-16
- user_id: abc123 ‚Üí abc123
- aggregated: N/A ‚Üí N/A
```

### DESPU√âS (con triggers optimizados):
```
‚úÖ SOLO el campo que realmente cambi√≥:

Campo modificado: Total Activos
Anterior: S/ 1,500,000
Nuevo: S/ 1,750,000
```

**Ventajas:**
- ‚úÖ Historial limpio y claro
- ‚úÖ Solo campos relevantes de negocio
- ‚úÖ F√°cil de entender qu√© cambi√≥ exactamente
- ‚úÖ No se registran cambios de campos de sistema

## ‚ö†Ô∏è Notas Importantes

1. **Ejecuta el script UNA SOLA VEZ** por proyecto
2. Si ya ejecutaste el script antes, no hay problema en ejecutarlo nuevamente (usa `CREATE OR REPLACE`)
3. Los logs solo capturar√°n cambios **despu√©s** de ejecutar el script
4. Los cambios hist√≥ricos anteriores no se pueden recuperar

## üßπ Ya Ejecut√© el Script Anterior y Tengo Muchos Campos?

Si ya ejecutaste una versi√≥n anterior del script y ahora ves muchos campos irrelevantes en el historial:

1. **Ejecuta el nuevo script optimizado** (`rib_reporte_tributario_audit_log_setup.sql`)
   - Esto actualizar√° el trigger para que los **NUEVOS** cambios solo capturen campos relevantes

2. **OPCIONAL: Limpia registros antiguos**
   - Usa el script `limpiar_audit_log_antiguo.sql` para eliminar registros viejos
   - **ADVERTENCIA**: Esto borrar√° el historial anterior
   - Solo hazlo si quieres empezar con un historial limpio

## üÜò Troubleshooting

### Problema: "permission denied"
**Soluci√≥n**: Aseg√∫rate de estar conectado como el propietario del proyecto o tener permisos de administrador.

### Problema: "relation already exists"
**Soluci√≥n**: El script ya fue ejecutado anteriormente. Puedes continuar sin problemas.

### Problema: Los valores siguen mostrando "N/A"
**Soluci√≥n**: 
1. Verifica que los triggers se crearon correctamente
2. Cierra sesi√≥n y vuelve a iniciar sesi√≥n en la aplicaci√≥n
3. Haz un cambio NUEVO en un reporte (los cambios viejos no se pueden recuperar)

## üìû Soporte

Si tienes problemas al ejecutar el script o necesitas ayuda adicional, contacta al equipo de desarrollo.

---

**√öltima actualizaci√≥n**: Octubre 2025
