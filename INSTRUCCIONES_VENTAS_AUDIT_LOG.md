# üìã Instrucciones para Activar Audit Log de Ventas Mensuales

## 1Ô∏è‚É£ Ejecutar el Script SQL

1. Abre tu proyecto en **Supabase Dashboard**
2. Ve a **SQL Editor** (en el men√∫ lateral izquierdo)
3. Abre el archivo `ventas_mensuales_audit_log_setup.sql`
4. Copia **TODO** el contenido del archivo
5. P√©galo en el SQL Editor de Supabase
6. Click en **"Run"** (bot√≥n verde en la esquina inferior derecha)
7. Espera a que aparezca el mensaje: **"Success. No rows returned"**

## 2Ô∏è‚É£ Verificar que se Instal√≥ Correctamente

Ejecuta esta consulta en el SQL Editor:

```sql
-- Verificar que la tabla existe
SELECT * FROM information_schema.tables 
WHERE table_name = 'ventas_mensuales_audit_log';

-- Verificar que los triggers existen
SELECT trigger_name, event_manipulation, event_object_table
FROM information_schema.triggers 
WHERE trigger_name LIKE 'ventas_mensuales_audit%';
```

Deber√≠as ver:
- ‚úÖ 1 tabla: `ventas_mensuales_audit_log`
- ‚úÖ 3 triggers: `ventas_mensuales_audit_insert`, `ventas_mensuales_audit_update`, `ventas_mensuales_audit_delete`

## 3Ô∏è‚É£ Probar el Audit Log

### Paso 1: Editar un Reporte Existente
1. Ve a `/ventas-mensuales` en tu aplicaci√≥n
2. Haz click en **Editar** en cualquier reporte
3. Modifica alg√∫n valor (ej: cambia Enero de 5639304 a 5639305)
4. Dale **"Guardar Cambios"**

### Paso 2: Ver el Historial
1. En el mismo formulario de edici√≥n, haz click en el bot√≥n **"Historial de Cambios"** (arriba a la derecha)
2. Deber√≠as ver un modal con:
   - ‚úÖ La fecha y hora del cambio
   - ‚úÖ El usuario que hizo el cambio
   - ‚úÖ El campo que cambi√≥ (ej: "enero (2023)")
   - ‚úÖ El valor anterior y el nuevo valor

### Paso 3: Verificar en la Base de Datos
Ejecuta esta consulta para ver los logs:

```sql
SELECT 
    val.id,
    val.action,
    val.user_email,
    val.changed_fields,
    val.old_values,
    val.new_values,
    val.created_at
FROM ventas_mensuales_audit_log val
JOIN ventas_mensuales vm ON val.ventas_mensuales_id = vm.id
WHERE vm.proveedor_ruc = '20556964620'  -- Cambia por el RUC que editaste
ORDER BY val.created_at DESC
LIMIT 10;
```

## ‚öôÔ∏è C√≥mo Funciona

### ¬øQu√© se Registra?
- ‚úÖ Cambios en cualquier mes (enero - diciembre)
- ‚úÖ Cambios de status (Borrador, Validado, Rechazado)
- ‚úÖ Cambios en "Validado Por"
- ‚úÖ Cambios en la Solicitud de Operaci√≥n asociada

### ¬øQu√© NO se Registra?
- ‚ùå Creaci√≥n de nuevos registros (INSERT)
- ‚ùå Eliminaci√≥n de registros (DELETE)
- ‚ùå Cambios en campos t√©cnicos (id, created_at, updated_at, user_id)

### Agrupaci√≥n de Logs
Cuando guardas un reporte que tiene m√∫ltiples a√±os (ej: 2019, 2023, 2024, 2025), cada a√±o genera su propio log, pero el visor los **agrupa visualmente** si fueron guardados al mismo tiempo por el mismo usuario.

## üìä Visualizaci√≥n en el Frontend

El bot√≥n "Historial de Cambios" aparece:
- ‚úÖ Solo cuando est√°s **editando** un reporte existente
- ‚úÖ En la esquina superior derecha, junto al bot√≥n "Volver a la lista"

Al hacer click:
- ‚úÖ Se abre un modal con todos los cambios
- ‚úÖ Los cambios est√°n agrupados por operaci√≥n (si editaste varios a√±os a la vez)
- ‚úÖ Cada campo muestra el a√±o al que pertenece (ej: "enero (2023)")
- ‚úÖ Los logs est√°n ordenados del m√°s reciente al m√°s antiguo

## üéØ Notas Importantes

1. **M√∫ltiples A√±os, M√∫ltiples Logs**: Si un reporte tiene datos para 4 a√±os diferentes (2019, 2023, 2024, 2025) y editas un valor en cada a√±o, se generar√°n 4 logs (uno por a√±o), pero se mostrar√°n agrupados visualmente.

2. **Solo UPDATE**: El trigger solo captura cambios reales (UPDATE), no creaciones ni eliminaciones.

3. **Campos Monitoreados**: Solo se registran cambios en los campos de negocio importantes, no en campos t√©cnicos del sistema.

## üêõ Troubleshooting

### No se est√°n generando logs
```sql
-- Verificar que los triggers existen
SELECT * FROM information_schema.triggers 
WHERE event_object_table = 'ventas_mensuales';
```

### Los logs no se muestran en el frontend
1. Abre la Consola del navegador (F12)
2. Busca errores relacionados con `ventas_mensuales_audit_log`
3. Verifica que el usuario tenga permisos (RLS debe estar configurado)

### Ver logs directamente en la BD
```sql
SELECT * FROM ventas_mensuales_audit_log 
ORDER BY created_at DESC 
LIMIT 20;
```

---

## ‚úÖ Checklist Final

- [ ] Script SQL ejecutado exitosamente
- [ ] Tabla `ventas_mensuales_audit_log` creada
- [ ] 3 Triggers creados
- [ ] RLS habilitado
- [ ] Pol√≠ticas de acceso creadas
- [ ] Probado editando un reporte
- [ ] Historial visible en el modal
- [ ] Logs visibles en la base de datos

---

¬°Listo! El sistema de audit log est√° configurado y funcionando. üéâ
