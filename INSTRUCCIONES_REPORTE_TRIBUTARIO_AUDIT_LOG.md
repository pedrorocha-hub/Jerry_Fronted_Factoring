# Instrucciones para Configurar Audit Log de Reporte Tributario

Este documento explica c√≥mo configurar el sistema de auditor√≠a para la tabla `reporte_tributario` en Supabase.

## üìã Resumen

El sistema de audit log para Reporte Tributario permite rastrear todos los cambios realizados en los reportes tributarios anuales, incluyendo:
- Cambios en informaci√≥n general (a√±o, RUC, raz√≥n social)
- Modificaciones en datos de RUC (estado, condici√≥n, actividad econ√≥mica)
- Actualizaciones en declaraci√≥n anual de renta (ingresos, activos, patrimonio, resultados)
- Cambios en ITAN (declaraci√≥n, base imponible, cuotas)
- Modificaciones en ingresos y ventas mensuales

## üöÄ Pasos para la Configuraci√≥n

### 1. Acceder a Supabase

1. Abre tu proyecto en [Supabase](https://supabase.com)
2. Ve a la secci√≥n **SQL Editor** en el men√∫ lateral

### 2. Ejecutar el Script SQL

1. Abre el archivo `reporte_tributario_audit_log_setup.sql` ubicado en la ra√≠z del proyecto
2. Copia todo el contenido del archivo
3. P√©galo en el editor SQL de Supabase
4. Haz clic en **Run** o presiona `Ctrl+Enter` (Windows/Linux) o `Cmd+Enter` (Mac)

### 3. Verificar la Instalaci√≥n

Ejecuta las siguientes consultas para verificar que todo se instal√≥ correctamente:

```sql
-- Ver la tabla creada
SELECT * FROM information_schema.tables WHERE table_name = 'reporte_tributario_audit_log';

-- Ver los triggers creados
SELECT * FROM information_schema.triggers WHERE trigger_name LIKE 'reporte_tributario_audit%';

-- Ver pol√≠ticas de RLS
SELECT * FROM pg_policies WHERE tablename = 'reporte_tributario_audit_log';
```

## üìä Estructura de la Tabla

La tabla `reporte_tributario_audit_log` tiene la siguiente estructura:

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | Identificador √∫nico del log |
| `reporte_tributario_id` | INTEGER | ID del reporte tributario relacionado |
| `user_id` | UUID | ID del usuario que realiz√≥ el cambio |
| `user_email` | TEXT | Email del usuario que realiz√≥ el cambio |
| `action` | TEXT | Tipo de acci√≥n: 'created', 'updated', 'deleted' |
| `changed_fields` | JSONB | Campos que fueron modificados |
| `old_values` | JSONB | Valores anteriores de los campos |
| `new_values` | JSONB | Valores nuevos de los campos |
| `created_at` | TIMESTAMPTZ | Fecha y hora del cambio |

## üîç Campos Monitoreados

El sistema de auditor√≠a rastrea cambios en los campos m√°s importantes:

### Informaci√≥n General
- **anio_reporte**: A√±o del reporte
- **razon_social**: Raz√≥n social de la empresa
- **ruc**: RUC de la empresa

### Datos de RUC
- **ruc_estado_contribuyente**: Estado del contribuyente
- **ruc_condicion_contribuyente**: Condici√≥n del contribuyente  
- **ruc_actividad_economica**: Actividad econ√≥mica principal

### Declaraci√≥n Anual de Renta (Campos Principales)
- **renta_ingresos_netos**: Ingresos netos del ejercicio
- **renta_otros_ingresos**: Otros ingresos
- **renta_total_activos_netos**: Total de activos netos
- **renta_total_cuentas_por_pagar**: Total de cuentas por pagar
- **renta_total_patrimonio**: Total patrimonio
- **renta_capital_social**: Capital social
- **renta_resultado_bruto**: Resultado bruto
- **renta_resultado_antes_participaciones**: Resultado antes de participaciones
- **renta_importe_pagado**: Importe pagado

### ITAN (Impuesto Temporal a los Activos Netos)
- **itan_presento_declaracion**: Si present√≥ declaraci√≥n ITAN
- **itan_base_imponible**: Base imponible
- **itan_itan_a_pagar**: ITAN a pagar

### Ingresos Mensuales Declarados
- **ingresos_enero** a **ingresos_diciembre**: Ingresos de cada mes

### Ventas Anuales
- **ventas_total_ingresos**: Total de ingresos anuales
- **ventas_total_essalud**: Total ESSALUD anual

## üí° Funcionamiento

### Triggers Autom√°ticos

El sistema utiliza triggers de PostgreSQL que se ejecutan autom√°ticamente cuando:
- Se actualiza un Reporte Tributario (`UPDATE`)

**Nota:** Por dise√±o, NO se auditan las siguientes operaciones para evitar ruido:
- Creaci√≥n de nuevos registros (`INSERT`)
- Eliminaci√≥n de registros (`DELETE`)

### Contexto del A√±o

El sistema incluye autom√°ticamente el a√±o del reporte en todos los logs, lo que facilita identificar a qu√© per√≠odo fiscal corresponde cada cambio.

## üéØ Uso en la Aplicaci√≥n

### Ver el Historial de Auditor√≠a

El historial de auditor√≠a est√° disponible en:

1. **Modal de Reporte Tributario**: Cuando visualizas o editas un reporte tributario, encontrar√°s un bot√≥n "Ver Historial de Cambios" en la parte superior del modal (solo visible para administradores).

El visor de auditor√≠a incluye:
- **Filtros avanzados**: Por fecha, acci√≥n, y usuario
- **Agrupaci√≥n inteligente**: Los cambios realizados en la misma operaci√≥n se agrupan juntos
- **Formato amigable**: Los valores monetarios se formatean autom√°ticamente en soles peruanos (PEN)
- **Fechas legibles**: Las fechas se muestran en formato dd/mm/aaaa
- **Informaci√≥n completa**: Muestra valores anteriores y nuevos para cada campo modificado
- **Contexto del a√±o**: Cada cambio incluye el a√±o del reporte al que pertenece

### Caracter√≠sticas del Visor

- üïí **Timeline visual**: Muestra todos los cambios en orden cronol√≥gico
- üë§ **Informaci√≥n del usuario**: Muestra qui√©n realiz√≥ cada cambio
- üìÖ **Filtros de fecha**: Filtra cambios por rango de fechas
- üéØ **Filtros de acci√≥n**: Filtra por tipo de cambio (actualizado)
- üë• **Filtros de usuario**: Busca cambios realizados por usuarios espec√≠ficos
- üí∞ **Formato de moneda**: Todos los valores monetarios se muestran en formato PEN (soles peruanos)
- üìä **Categorizaci√≥n**: Los campos se organizan por categor√≠as (General, RUC, Renta, ITAN, Ingresos, Ventas)

## üîí Seguridad (RLS)

El sistema implementa Row Level Security (RLS) con las siguientes pol√≠ticas:

- **SELECT**: Todos los usuarios autenticados pueden ver los logs de auditor√≠a
- **INSERT**: Solo el sistema puede insertar logs (v√≠a triggers)
- **UPDATE/DELETE**: No permitido para ning√∫n usuario

Esto garantiza que los logs de auditor√≠a sean inmutables y confiables.

## üß™ Probar el Sistema

Para probar que el sistema funciona correctamente:

1. Ve a la p√°gina de Reportes Tributarios en la aplicaci√≥n
2. Selecciona una empresa y visualiza sus reportes
3. Haz clic en "Ver" o "Editar" en cualquier reporte
4. Haz clic en el bot√≥n "Ver Historial de Cambios"
5. Si no hay cambios previos, edita el reporte:
   - Modifica alg√∫n campo, por ejemplo:
     - Cambia los ingresos netos
     - Actualiza el resultado bruto
     - Modifica alg√∫n ingreso mensual
6. Guarda los cambios
7. Vuelve a abrir el visor de historial de auditor√≠a
8. Deber√≠as ver el cambio registrado con:
   - Tu nombre de usuario
   - Los campos que modificaste con nombres descriptivos
   - Los valores anteriores y nuevos en el formato apropiado (moneda o texto)
   - El a√±o del reporte entre par√©ntesis
   - La fecha y hora exacta del cambio

## ‚ùì Soluci√≥n de Problemas

### Los cambios no se registran

1. Verifica que los triggers est√©n activos:
```sql
SELECT * FROM information_schema.triggers 
WHERE trigger_name LIKE 'reporte_tributario_audit%';
```

2. Verifica los permisos de RLS:
```sql
SELECT * FROM pg_policies WHERE tablename = 'reporte_tributario_audit_log';
```

### No puedo ver el historial

1. Verifica que est√©s autenticado en la aplicaci√≥n
2. Comprueba que la tabla `reporte_tributario_audit_log` existe
3. Verifica que eres administrador (el bot√≥n solo es visible para admins)
4. Revisa la consola del navegador en busca de errores

### Errores de permisos

Si obtienes errores de permisos al ejecutar el script:
- Aseg√∫rate de estar conectado como administrador del proyecto en Supabase
- Verifica que tienes permisos suficientes en tu organizaci√≥n de Supabase

## üìù Mantenimiento

### Limpiar logs antiguos (opcional)

Si deseas eliminar logs antiguos para liberar espacio:

```sql
-- Eliminar logs m√°s antiguos de 3 a√±os
DELETE FROM reporte_tributario_audit_log 
WHERE created_at < NOW() - INTERVAL '3 years';
```

### Ver estad√≠sticas de auditor√≠a

```sql
-- Contar logs por usuario
SELECT user_email, COUNT(*) as total_changes
FROM reporte_tributario_audit_log
GROUP BY user_email
ORDER BY total_changes DESC;

-- Contar logs por acci√≥n
SELECT action, COUNT(*) as total
FROM reporte_tributario_audit_log
GROUP BY action;

-- Ver los cambios m√°s recientes
SELECT 
  rt.ruc,
  rt.razon_social,
  rt.anio_reporte,
  a.action,
  a.user_email,
  a.created_at
FROM reporte_tributario_audit_log a
JOIN reporte_tributario rt ON rt.id = a.reporte_tributario_id
ORDER BY a.created_at DESC
LIMIT 10;
```

### Analizar cambios por empresa

```sql
-- Ver historial de cambios para un RUC espec√≠fico
SELECT 
  rt.ruc,
  rt.razon_social,
  rt.anio_reporte,
  a.action,
  a.changed_fields,
  a.user_email,
  a.created_at
FROM reporte_tributario_audit_log a
JOIN reporte_tributario rt ON rt.id = a.reporte_tributario_id
WHERE rt.ruc = '20123456789'  -- Reemplaza con el RUC que deseas consultar
ORDER BY a.created_at DESC;
```

### Analizar cambios en campos espec√≠ficos

```sql
-- Ver todos los cambios en ingresos netos
SELECT 
  rt.ruc,
  rt.razon_social,
  rt.anio_reporte,
  a.old_values->>'renta_ingresos_netos' as ingreso_anterior,
  a.new_values->>'renta_ingresos_netos' as ingreso_nuevo,
  a.user_email,
  a.created_at
FROM reporte_tributario_audit_log a
JOIN reporte_tributario rt ON rt.id = a.reporte_tributario_id
WHERE a.changed_fields->>'renta_ingresos_netos' = 'true'
ORDER BY a.created_at DESC;
```

## üéì Buenas Pr√°cticas

1. **No modifiques manualmente** los logs de auditor√≠a - son gestionados autom√°ticamente por el sistema
2. **Revisa regularmente** los cambios en reportes tributarios para asegurar la integridad de los datos fiscales
3. **Utiliza los filtros** del visor para encontrar cambios espec√≠ficos r√°pidamente
4. **Documenta grandes cambios** en tus registros internos, especialmente ajustes de cierre fiscal
5. **Verifica la consistencia** entre diferentes per√≠odos al revisar cambios hist√≥ricos
6. **Mant√©n un registro externo** de las razones de cambios importantes

## üìö Casos de Uso Comunes

### Auditor√≠a de cierre fiscal anual
Revisa todos los cambios realizados durante el cierre del ejercicio fiscal:
```sql
SELECT * FROM reporte_tributario_audit_log 
WHERE created_at BETWEEN '2024-12-01' AND '2025-03-31'
ORDER BY created_at;
```

### Verificaci√≥n de correcciones tributarias
Identifica cu√°ndo y qui√©n realiz√≥ correcciones en declaraciones:
```sql
SELECT 
  rt.ruc,
  rt.anio_reporte,
  a.changed_fields,
  a.old_values,
  a.new_values,
  a.user_email,
  a.created_at
FROM reporte_tributario_audit_log a
JOIN reporte_tributario rt ON rt.id = a.reporte_tributario_id
WHERE a.changed_fields ? 'renta_resultado_antes_participaciones'
ORDER BY a.created_at DESC;
```

### An√°lisis de cambios en ingresos mensuales
Revisa las modificaciones en declaraciones mensuales:
```sql
SELECT 
  rt.ruc,
  rt.anio_reporte,
  jsonb_object_keys(a.changed_fields) as campo_cambiado,
  a.old_values,
  a.new_values,
  a.created_at
FROM reporte_tributario_audit_log a
JOIN reporte_tributario rt ON rt.id = a.reporte_tributario_id
WHERE jsonb_object_keys(a.changed_fields) LIKE 'ingresos_%'
ORDER BY a.created_at DESC;
```

### Reconciliaci√≥n de datos hist√≥ricos
Compara valores hist√≥ricos con valores actuales para identificar discrepancias.

## üìû Soporte

Si encuentras alg√∫n problema o tienes preguntas sobre el sistema de auditor√≠a de Reporte Tributario, contacta al equipo de desarrollo.

---

**√öltima actualizaci√≥n**: Octubre 2025
**Versi√≥n del sistema**: 1.0

