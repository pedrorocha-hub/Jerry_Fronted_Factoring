# Instrucciones para Configurar Audit Log de EEFF (Estados Financieros)

Este documento explica c√≥mo configurar el sistema de auditor√≠a para la tabla `eeff` en Supabase.

## üìã Resumen

El sistema de audit log para EEFF permite rastrear todos los cambios realizados en los Estados Financieros, incluyendo:
- Cambios en RUC y a√±o del reporte
- Modificaciones en activos (efectivo, inversiones, cuentas por cobrar, inventarios, etc.)
- Actualizaciones en pasivos (sobregiros, cuentas por pagar, obligaciones financieras, etc.)
- Cambios en patrimonio (capital, reservas, resultados, utilidades/p√©rdidas, etc.)

## üöÄ Pasos para la Configuraci√≥n

### 1. Acceder a Supabase

1. Abre tu proyecto en [Supabase](https://supabase.com)
2. Ve a la secci√≥n **SQL Editor** en el men√∫ lateral

### 2. Ejecutar el Script SQL

1. Abre el archivo `eeff_audit_log_setup.sql` ubicado en la ra√≠z del proyecto
2. Copia todo el contenido del archivo
3. P√©galo en el editor SQL de Supabase
4. Haz clic en **Run** o presiona `Ctrl+Enter` (Windows/Linux) o `Cmd+Enter` (Mac)

### 3. Verificar la Instalaci√≥n

Ejecuta las siguientes consultas para verificar que todo se instal√≥ correctamente:

```sql
-- Ver la tabla creada
SELECT * FROM information_schema.tables WHERE table_name = 'eeff_audit_log';

-- Ver los triggers creados
SELECT * FROM information_schema.triggers WHERE trigger_name LIKE 'eeff_audit%';

-- Ver pol√≠ticas de RLS
SELECT * FROM pg_policies WHERE tablename = 'eeff_audit_log';
```

## üìä Estructura de la Tabla

La tabla `eeff_audit_log` tiene la siguiente estructura:

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | Identificador √∫nico del log |
| `eeff_id` | UUID | ID del EEFF relacionado |
| `user_id` | UUID | ID del usuario que realiz√≥ el cambio |
| `user_email` | TEXT | Email del usuario que realiz√≥ el cambio |
| `action` | TEXT | Tipo de acci√≥n: 'created', 'updated', 'deleted' |
| `changed_fields` | JSONB | Campos que fueron modificados |
| `old_values` | JSONB | Valores anteriores de los campos |
| `new_values` | JSONB | Valores nuevos de los campos |
| `created_at` | TIMESTAMPTZ | Fecha y hora del cambio |

## üîç Campos Monitoreados

El sistema de auditor√≠a rastrea cambios en los campos principales de cada categor√≠a:

### Informaci√≥n General
- **ruc**: RUC de la empresa
- **anio_reporte**: A√±o del reporte financiero

### Activos Principales
- **activo_efectivo_y_equivalentes_de_efectivo**: Efectivo disponible
- **activo_inversiones_financieras**: Inversiones
- **activo_ctas_por_cobrar_comerciales_terceros**: Cuentas por cobrar (terceros)
- **activo_ctas_por_cobrar_comerciales_relacionadas**: Cuentas por cobrar (relacionadas)
- **activo_mercaderias**: Mercader√≠as en inventario
- **activo_productos_terminados**: Productos terminados
- **activo_materias_primas**: Materias primas
- **activo_propiedades_planta_y_equipo**: Propiedad, planta y equipo
- **activo_total_activo_neto**: Total de activos netos

### Pasivos Principales
- **pasivo_sobregiros_bancarios**: Sobregiros bancarios
- **pasivo_ctas_por_pagar_comerciales_terceros**: Cuentas por pagar (terceros)
- **pasivo_ctas_por_pagar_comerciales_relacionadas**: Cuentas por pagar (relacionadas)
- **pasivo_obligaciones_financieras**: Obligaciones financieras
- **pasivo_total_pasivo**: Total de pasivos

### Patrimonio Principal
- **patrimonio_capital**: Capital social
- **patrimonio_reservas**: Reservas
- **patrimonio_resultados_acumulados_positivos**: Resultados acumulados positivos
- **patrimonio_resultados_acumulados_negativos**: Resultados acumulados negativos
- **patrimonio_utilidad_de_ejercicio**: Utilidad del ejercicio
- **patrimonio_perdida_de_ejercicio**: P√©rdida del ejercicio
- **patrimonio_total_patrimonio**: Total patrimonio
- **patrimonio_total_pasivo_y_patrimonio**: Total pasivo y patrimonio

## üí° Funcionamiento

### Triggers Autom√°ticos

El sistema utiliza triggers de PostgreSQL que se ejecutan autom√°ticamente cuando:
- Se actualiza un Estado Financiero (`UPDATE`)

**Nota:** Por dise√±o, NO se auditan las siguientes operaciones para evitar ruido:
- Creaci√≥n de nuevos registros (`INSERT`)
- Eliminaci√≥n de registros (`DELETE`)

### Contexto del A√±o

El sistema incluye autom√°ticamente el a√±o del reporte en todos los logs, lo que facilita identificar a qu√© per√≠odo financiero corresponde cada cambio.

## üéØ Uso en la Aplicaci√≥n

### Ver el Historial de Auditor√≠a

El historial de auditor√≠a est√° disponible en:

1. **Formulario de Edici√≥n de EEFF**: Cuando editas un Estado Financiero, encontrar√°s un bot√≥n "Ver Historial de Cambios" en la parte superior derecha del formulario, junto al bot√≥n "Volver al listado".

El visor de auditor√≠a incluye:
- **Filtros avanzados**: Por fecha, acci√≥n, y usuario
- **Agrupaci√≥n inteligente**: Los cambios realizados en la misma operaci√≥n se agrupan juntos
- **Formato amigable**: Los valores monetarios se formatean autom√°ticamente en soles peruanos (PEN)
- **Informaci√≥n completa**: Muestra valores anteriores y nuevos para cada campo modificado
- **Contexto del a√±o**: Cada campo modificado muestra el a√±o del reporte al que pertenece

### Caracter√≠sticas del Visor

- üïí **Timeline visual**: Muestra todos los cambios en orden cronol√≥gico
- üë§ **Informaci√≥n del usuario**: Muestra qui√©n realiz√≥ cada cambio
- üìÖ **Filtros de fecha**: Filtra cambios por rango de fechas
- üéØ **Filtros de acci√≥n**: Filtra por tipo de cambio (actualizado)
- üë• **Filtros de usuario**: Busca cambios realizados por usuarios espec√≠ficos
- üí∞ **Formato de moneda**: Todos los valores se muestran en formato PEN (soles peruanos)
- üìä **Categorizaci√≥n**: Los campos se muestran con nombres descriptivos (Activos, Pasivos, Patrimonio)

## üîí Seguridad (RLS)

El sistema implementa Row Level Security (RLS) con las siguientes pol√≠ticas:

- **SELECT**: Todos los usuarios autenticados pueden ver los logs de auditor√≠a
- **INSERT**: Solo el sistema puede insertar logs (v√≠a triggers)
- **UPDATE/DELETE**: No permitido para ning√∫n usuario

Esto garantiza que los logs de auditor√≠a sean inmutables y confiables.

## üß™ Probar el Sistema

Para probar que el sistema funciona correctamente:

1. Ve a la p√°gina de EEFF en la aplicaci√≥n (`/eeff`)
2. Haz clic en "Editar" en cualquier Estado Financiero existente
3. Haz clic en el bot√≥n "Ver Historial de Cambios" (√≠cono de reloj/historial)
4. Modifica alg√∫n campo, por ejemplo:
   - Cambia el total de activos
   - Actualiza el patrimonio
   - Modifica alguna cuenta por cobrar
5. Guarda los cambios
6. Vuelve a abrir el visor de historial de auditor√≠a
7. Deber√≠as ver el cambio registrado con:
   - Tu nombre de usuario
   - Los campos que modificaste con nombres descriptivos
   - Los valores anteriores y nuevos en formato de moneda
   - El a√±o del reporte entre par√©ntesis
   - La fecha y hora exacta del cambio

## ‚ùì Soluci√≥n de Problemas

### Los cambios no se registran

1. Verifica que los triggers est√©n activos:
```sql
SELECT * FROM information_schema.triggers 
WHERE trigger_name LIKE 'eeff_audit%';
```

2. Verifica los permisos de RLS:
```sql
SELECT * FROM pg_policies WHERE tablename = 'eeff_audit_log';
```

### No puedo ver el historial

1. Verifica que est√©s autenticado en la aplicaci√≥n
2. Comprueba que la tabla `eeff_audit_log` existe
3. Revisa la consola del navegador en busca de errores
4. Aseg√∫rate de estar en modo "edici√≥n" de un EEFF existente

### Errores de permisos

Si obtienes errores de permisos al ejecutar el script:
- Aseg√∫rate de estar conectado como administrador del proyecto en Supabase
- Verifica que tienes permisos suficientes en tu organizaci√≥n de Supabase

## üìù Mantenimiento

### Limpiar logs antiguos (opcional)

Si deseas eliminar logs antiguos para liberar espacio:

```sql
-- Eliminar logs m√°s antiguos de 2 a√±os
DELETE FROM eeff_audit_log 
WHERE created_at < NOW() - INTERVAL '2 years';
```

### Ver estad√≠sticas de auditor√≠a

```sql
-- Contar logs por usuario
SELECT user_email, COUNT(*) as total_changes
FROM eeff_audit_log
GROUP BY user_email
ORDER BY total_changes DESC;

-- Contar logs por acci√≥n
SELECT action, COUNT(*) as total
FROM eeff_audit_log
GROUP BY action;

-- Ver los cambios m√°s recientes
SELECT 
  e.ruc,
  e.anio_reporte,
  a.action,
  a.user_email,
  a.created_at
FROM eeff_audit_log a
JOIN eeff e ON e.id = a.eeff_id
ORDER BY a.created_at DESC
LIMIT 10;
```

### Analizar cambios por empresa

```sql
-- Ver historial de cambios para un RUC espec√≠fico
SELECT 
  e.ruc,
  e.anio_reporte,
  a.action,
  a.changed_fields,
  a.user_email,
  a.created_at
FROM eeff_audit_log a
JOIN eeff e ON e.id = a.eeff_id
WHERE e.ruc = '20123456789'  -- Reemplaza con el RUC que deseas consultar
ORDER BY a.created_at DESC;
```

## üéì Buenas Pr√°cticas

1. **No modifiques manualmente** los logs de auditor√≠a - son gestionados autom√°ticamente por el sistema
2. **Revisa regularmente** los cambios en estados financieros importantes para asegurar la integridad de los datos
3. **Utiliza los filtros** del visor para encontrar cambios espec√≠ficos r√°pidamente
4. **Documenta grandes cambios** en tus registros internos, especialmente ajustes significativos
5. **Verifica la consistencia** entre activo, pasivo y patrimonio al revisar cambios hist√≥ricos
6. **Mant√©n un registro** de las razones de cambios importantes fuera del sistema de auditor√≠a

## üìö Casos de Uso Comunes

### Auditor√≠a de fin de a√±o
Revisa todos los cambios realizados a los estados financieros durante el cierre fiscal:
```sql
SELECT * FROM eeff_audit_log 
WHERE created_at BETWEEN '2024-01-01' AND '2024-12-31'
ORDER BY created_at;
```

### Verificaci√≥n de ajustes contables
Identifica cu√°ndo y qui√©n realiz√≥ ajustes importantes en cuentas espec√≠ficas usando los filtros del visor web.

### Reconciliaci√≥n de datos
Compara valores hist√≥ricos con valores actuales para identificar discrepancias.

## üìû Soporte

Si encuentras alg√∫n problema o tienes preguntas sobre el sistema de auditor√≠a de EEFF, contacta al equipo de desarrollo.

---

**√öltima actualizaci√≥n**: Octubre 2025
**Versi√≥n del sistema**: 1.0

