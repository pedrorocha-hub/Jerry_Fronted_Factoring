# Instrucciones para Configurar Audit Log de Sentinel

Este documento explica c√≥mo configurar el sistema de auditor√≠a para la tabla `sentinel` en Supabase.

## üìã Resumen

El sistema de audit log para Sentinel permite rastrear todos los cambios realizados en los documentos Sentinel, incluyendo:
- Cambios en RUC
- Cambios de estado
- Modificaciones en score y calificaciones
- Actualizaciones en deudas (directa, indirecta, SUNAT)
- Cambios en impagos y protestos

## üöÄ Pasos para la Configuraci√≥n

### 1. Acceder a Supabase

1. Abre tu proyecto en [Supabase](https://supabase.com)
2. Ve a la secci√≥n **SQL Editor** en el men√∫ lateral

### 2. Ejecutar el Script SQL

1. Abre el archivo `sentinel_audit_log_setup.sql` ubicado en la ra√≠z del proyecto
2. Copia todo el contenido del archivo
3. P√©galo en el editor SQL de Supabase
4. Haz clic en **Run** o presiona `Ctrl+Enter` (Windows/Linux) o `Cmd+Enter` (Mac)

### 3. Verificar la Instalaci√≥n

Ejecuta las siguientes consultas para verificar que todo se instal√≥ correctamente:

```sql
-- Ver la tabla creada
SELECT * FROM information_schema.tables WHERE table_name = 'sentinel_audit_log';

-- Ver los triggers creados
SELECT * FROM information_schema.triggers WHERE trigger_name LIKE 'sentinel_audit%';

-- Ver pol√≠ticas de RLS
SELECT * FROM pg_policies WHERE tablename = 'sentinel_audit_log';
```

## üìä Estructura de la Tabla

La tabla `sentinel_audit_log` tiene la siguiente estructura:

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | Identificador √∫nico del log |
| `sentinel_id` | UUID | ID del documento Sentinel relacionado |
| `user_id` | UUID | ID del usuario que realiz√≥ el cambio |
| `user_email` | TEXT | Email del usuario que realiz√≥ el cambio |
| `action` | TEXT | Tipo de acci√≥n: 'created', 'updated', 'status_changed', 'deleted' |
| `changed_fields` | JSONB | Campos que fueron modificados |
| `old_values` | JSONB | Valores anteriores de los campos |
| `new_values` | JSONB | Valores nuevos de los campos |
| `created_at` | TIMESTAMPTZ | Fecha y hora del cambio |

## üîç Campos Monitoreados

El sistema de auditor√≠a rastrea cambios en los siguientes campos:

- **ruc**: RUC de la empresa
- **status**: Estado del documento
- **score**: Score o calificaci√≥n
- **comportamiento_calificacion**: Calificaci√≥n del comportamiento
- **deuda_directa**: Monto de deuda directa
- **deuda_indirecta**: Monto de deuda indirecta
- **impagos**: Monto de impagos
- **deudas_sunat**: Monto de deudas con SUNAT
- **protestos**: Monto de protestos

## üí° Funcionamiento

### Triggers Autom√°ticos

El sistema utiliza triggers de PostgreSQL que se ejecutan autom√°ticamente cuando:
- Se actualiza un documento Sentinel (`UPDATE`)

**Nota:** Por dise√±o, NO se auditan las siguientes operaciones para evitar ruido:
- Creaci√≥n de nuevos registros (`INSERT`)
- Eliminaci√≥n de registros (`DELETE`)

### Cambios de Estado Especiales

Cuando el campo `status` cambia, el sistema registra la acci√≥n como `status_changed` en lugar de `updated`, lo que permite filtrar y visualizar los cambios de estado de manera m√°s espec√≠fica.

## üéØ Uso en la Aplicaci√≥n

### Ver el Historial de Auditor√≠a

El historial de auditor√≠a est√° disponible en:

1. **Modal de Sentinel**: Cuando ves o editas un documento Sentinel, encontrar√°s un bot√≥n "Ver Historial de Cambios" en la parte superior del modal.

El visor de auditor√≠a incluye:
- **Filtros avanzados**: Por fecha, acci√≥n, y usuario
- **Agrupaci√≥n inteligente**: Los cambios realizados en la misma operaci√≥n se agrupan juntos
- **Formato amigable**: Los valores monetarios se formatean autom√°ticamente en soles peruanos
- **Informaci√≥n completa**: Muestra valores anteriores y nuevos para cada campo modificado

### Caracter√≠sticas del Visor

- üïí **Timeline visual**: Muestra todos los cambios en orden cronol√≥gico
- üë§ **Informaci√≥n del usuario**: Muestra qui√©n realiz√≥ cada cambio
- üìÖ **Filtros de fecha**: Filtra cambios por rango de fechas
- üéØ **Filtros de acci√≥n**: Filtra por tipo de cambio (actualizado, estado cambiado, etc.)
- üë• **Filtros de usuario**: Busca cambios realizados por usuarios espec√≠ficos
- üí∞ **Formato de moneda**: Los valores monetarios se muestran en formato PEN (soles)

## üîí Seguridad (RLS)

El sistema implementa Row Level Security (RLS) con las siguientes pol√≠ticas:

- **SELECT**: Todos los usuarios autenticados pueden ver los logs de auditor√≠a
- **INSERT**: Solo el sistema puede insertar logs (v√≠a triggers)
- **UPDATE/DELETE**: No permitido para ning√∫n usuario

Esto garantiza que los logs de auditor√≠a sean inmutables y confiables.

## üß™ Probar el Sistema

Para probar que el sistema funciona correctamente:

1. Ve a la p√°gina de Sentinel en la aplicaci√≥n
2. Abre un documento Sentinel existente
3. Edita alg√∫n campo (por ejemplo, cambia el score o la deuda directa)
4. Guarda los cambios
5. Abre el visor de historial de auditor√≠a
6. Deber√≠as ver el cambio registrado con:
   - Tu nombre de usuario
   - Los campos que modificaste
   - Los valores anteriores y nuevos
   - La fecha y hora exacta del cambio

## ‚ùì Soluci√≥n de Problemas

### Los cambios no se registran

1. Verifica que los triggers est√©n activos:
```sql
SELECT * FROM information_schema.triggers 
WHERE trigger_name LIKE 'sentinel_audit%';
```

2. Verifica los permisos de RLS:
```sql
SELECT * FROM pg_policies WHERE tablename = 'sentinel_audit_log';
```

### No puedo ver el historial

1. Verifica que est√©s autenticado en la aplicaci√≥n
2. Comprueba que la tabla `sentinel_audit_log` existe
3. Revisa la consola del navegador en busca de errores

### Errores de permisos

Si obtienes errores de permisos al ejecutar el script:
- Aseg√∫rate de estar conectado como administrador del proyecto en Supabase
- Verifica que tienes permisos suficientes en tu organizaci√≥n de Supabase

## üìù Mantenimiento

### Limpiar logs antiguos (opcional)

Si deseas eliminar logs antiguos para liberar espacio:

```sql
-- Eliminar logs m√°s antiguos de 1 a√±o
DELETE FROM sentinel_audit_log 
WHERE created_at < NOW() - INTERVAL '1 year';
```

### Ver estad√≠sticas de auditor√≠a

```sql
-- Contar logs por usuario
SELECT user_email, COUNT(*) as total_changes
FROM sentinel_audit_log
GROUP BY user_email
ORDER BY total_changes DESC;

-- Contar logs por tipo de acci√≥n
SELECT action, COUNT(*) as total
FROM sentinel_audit_log
GROUP BY action;
```

## üéì Buenas Pr√°cticas

1. **No modifiques manualmente** los logs de auditor√≠a - son gestionados autom√°ticamente por el sistema
2. **Revisa regularmente** los cambios importantes para mantener control sobre las modificaciones
3. **Utiliza los filtros** del visor para encontrar cambios espec√≠ficos r√°pidamente
4. **Documenta cambios importantes** usando comentarios en tu flujo de trabajo

## üìû Soporte

Si encuentras alg√∫n problema o tienes preguntas sobre el sistema de auditor√≠a, contacta al equipo de desarrollo.

---

**√öltima actualizaci√≥n**: Octubre 2025
**Versi√≥n del sistema**: 1.0

